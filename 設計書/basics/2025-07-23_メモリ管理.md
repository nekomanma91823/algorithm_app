---
tags:
  - computer_science
  - software
  - os
alias: メモリ管理の仕組み
---

# メモリ管理の仕組み：OSはどのようにメモリをやりくりしているか

## 概要

メモリ管理とは、コンピュータの限られた作業スペースである**メモリ（主記憶装置）を、OS（オペレーティングシステム）がどのように効率的かつ安全に管理するか**という仕組みのことです。もし適切なメモリ管理がなければ、メモリはすぐに使い果たされたり、プログラム同士が互いのデータを破壊しあったりして、システムは不安定になってしまいます。

## なぜメモリ管理が必要か？

現代のコンピュータは、複数のプログラム（プロセス）を同時に動かすのが当たり前です。OSによるメモリ管理は、以下の目的のために不可欠です。

1.  **効率的なリソース利用**: 限られたメモリを、多くのプロセスで無駄なく共有します。
2.  **プロセスの保護**: あるプロセスが、他のプロセスに割り当てられたメモリ領域を誤って読み書きしてしまうのを防ぎます。これにより、システム全体の安定性を保ちます。
3.  **物理メモリ以上の空間提供**: 後述する「仮想記憶」という仕組みを使い、物理的に搭載されているメモリ量よりも大きなメモリ空間が各プロセスにあるかのように見せかけます。

## OSによるメモリ管理の中心技術：「仮想記憶」

現代のOSにおけるメモリ管理の根幹をなすのが**仮想記憶（Virtual Memory）**という技術です。これは、物理的なメモリと、低速ですが大容量な**ストレージ（HDDやSSD）を巧みに連携させる**ことで、各プロセスに広大なメモリ空間を提供します。

### 仮想記憶の仕組み：ページング方式

仮想記憶を実現する最も一般的な方法が**ページング方式**です。

1.  **アドレス空間の分割**:
    -   **仮想アドレス空間**: OSが各プロセスに提供する「見かけ上の」広大なメモリ空間。
    -   **物理アドレス空間**: 実際にコンピュータに搭載されているメモリの空間。
    -   これらの空間を、**ページ**という比較的小さな固定サイズのブロック（例: 4KB）に分割します。

2.  **必要なページだけを物理メモリへ**:
    -   プロセスが実行されるとき、そのプロセスのすべてのページが物理メモリに読み込まれるわけではありません。**今まさに必要としているページだけ**が、物理メモリに読み込まれます（**デマンドページング**）。

3.  **ページフォールトとスワッピング**:
    -   もしプロセスが必要とするページが物理メモリ上に存在しない場合、「**ページフォールト**」という割り込みが発生します。
    -   これを検知したOSは、ストレージ（スワップ領域と呼ばれる特別な場所）から目的のページを探し出し、物理メモリ上の空いている領域に読み込みます。
    -   もし物理メモリに空きがない場合は、現在使われていないページをストレージに書き出し（**スワップアウト**）、空いたスペースに新しいページを読み込みます（**スワップイン**）。

この一連の仕組みにより、物理メモリの容量を気にすることなく、大きなアプリケーションでも安定して実行できるのです。

## プログラミングにおけるメモリ管理

プログラマがコードを書く際にも、メモリ管理は重要な課題です。これには大きく2つのアプローチがあります。

-   **手動メモリ管理 (C/C++)**:
    -   プログラマが `malloc()` などで明示的にメモリを確保し、不要になったら `free()` で解放する必要があります。
    -   **メリット**: メモリを制御するタイミングを細かく調整できるため、パフォーマンスを極限まで高められる。
    -   **デメリット**: 解放を忘れる「**メモリリーク**」や、解放済みの領域にアクセスするバグを生みやすく、非常に高度な注意が求められる。

-   **自動メモリ管理 (ガベージコレクション)**:
    -   Java, Python, C#, JavaScriptなど、多くの現代的な言語で採用されています。
    -   プログラム中で「どこからも参照されなくなった、不要なメモリ領域」を、**ガベージコレクタ(GC)** という仕組みが自動的に見つけ出して解放してくれます。
    -   **メリット**: プログラマがメモリ解放を意識する必要がなくなり、メモリリークなどのバグを劇的に減らせる。
    -   **デメリット**: GCがいつ動くか予測しづらく、GCの処理中はプログラムの実行が一時的に停止（Stop the World）することがあるため、厳密なリアルタイム性が求められるシステムには不向きな場合がある。

---

## 視覚化のアイデア

-   **「図書館」に例えた仮想記憶のイラスト**:
    -   **物理メモリ**: 閲覧室にある、すぐに手に取れる本棚（容量は小さい）。
    -   **ストレージ（スワップ領域）**: 地下にある巨大な書庫。
    -   **プロセス（利用者）**: 利用者は、自分の机（仮想アドレス空間）には無限に本が置けると思っている。
    -   **ページフォールト**: 利用者が必要な本が閲覧室の本棚になかった場合、司書（OS）に依頼する。
    -   **スワッピング**: 司書（OS）は、地下の書庫（ストレージ）から本を探してきて、閲覧室の本棚に持ってくる。もし本棚がいっぱいなら、誰も読んでいない本を書庫に戻してから、新しい本を置く。
-   **ページング方式の対応表（ページテーブル）**:
    -   左側にプロセスの「仮想アドレス空間」をページのリストとして描く（0, 1, 2, ...）。
    -   右側に「物理アドレス空間」をページのリストとして描く。
    -   中央に「ページテーブル」という対応表を置き、仮想ページの番号と物理ページの番号を線で結ぶ。
    -   物理メモリ上に存在しないページについては、線の先がストレージ（ディスクの絵）に向かっているように描き、スワップアウトされている状態を表現する。
-   **ガベージコレクションのイメージ**:
    -   メモリ空間を、たくさんのオブジェクト（荷物）が置かれた部屋として描く。
    -   プログラム（人）から、必要なオブジェクトに向かって線（参照）が伸びている。
    -   ガベージコレクタ（掃除ロボット）が登場し、どこからも線が伸びていない不要なオブジェクト（ゴミ）を自動的に回収していくアニメーション。
